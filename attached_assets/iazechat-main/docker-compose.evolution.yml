version: '3.8'

services:
  evolution-api:
    image: atendai/evolution-api:2.3.0
    container_name: evolution-api
    restart: always
    ports:
      - "8080:8080"
    environment:
      # Server Config
      - SERVER_URL=http://localhost:8080
      - CORS_ORIGIN=*
      - CORS_METHODS=GET,POST,PUT,DELETE
      - CORS_CREDENTIALS=true
      
      # Authentication
      - AUTHENTICATION_API_KEY=cybertv-suporte-evolution-key-2024
      
      # Database (PostgreSQL para Evolution API)
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://evolution:evolution123@postgres-evolution:5432/evolution
      - DATABASE_CONNECTION_CLIENT_NAME=evolution_prod
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - DATABASE_SAVE_MESSAGE_UPDATE=true
      - DATABASE_SAVE_DATA_CONTACTS=true
      - DATABASE_SAVE_DATA_CHATS=true
      
      # Redis (opcional, para cache)
      - CACHE_REDIS_ENABLED=false
      
      # RabbitMQ (opcional, para webhooks)
      - RABBITMQ_ENABLED=false
      
      # Webhook
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_URL=https://wppconnect-fix.preview.emergentagent.com/api/whatsapp/webhook
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=true
      - WEBHOOK_EVENTS_APPLICATION_STARTUP=false
      - WEBHOOK_EVENTS_QRCODE_UPDATED=true
      - WEBHOOK_EVENTS_MESSAGES_SET=true
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
      - WEBHOOK_EVENTS_MESSAGES_UPDATE=true
      - WEBHOOK_EVENTS_SEND_MESSAGE=false
      - WEBHOOK_EVENTS_CONNECTION_UPDATE=true
      
      # Log
      - LOG_LEVEL=ERROR
      - LOG_COLOR=true
      - LOG_BAILEYS=error
      
      # Storage
      - STORE_MESSAGES=true
      - STORE_MESSAGE_UP=true
      - STORE_CONTACTS=true
      - STORE_CHATS=true
      
      # QR Code
      - QRCODE_LIMIT=30
      - QRCODE_COLOR=#198754
      
      # Instance
      - CONFIG_SESSION_PHONE_CLIENT=Evolution API
      - CONFIG_SESSION_PHONE_NAME=Chrome
      - CONFIG_SESSION_PHONE_VERSION=2.3000.1025097974
      
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    
    depends_on:
      - postgres-evolution
    
    networks:
      - evolution-network

  postgres-evolution:
    image: postgres:15-alpine
    container_name: postgres-evolution
    restart: always
    environment:
      - POSTGRES_USER=evolution
      - POSTGRES_PASSWORD=evolution123
      - POSTGRES_DB=evolution
    volumes:
      - postgres_evolution_data:/var/lib/postgresql/data
    networks:
      - evolution-network

volumes:
  evolution_instances:
  evolution_store:
  postgres_evolution_data:

networks:
  evolution-network:
    driver: bridge

# INSTRUÇÕES DE USO:
# 
# 1. Iniciar Evolution API:
#    docker-compose -f docker-compose.evolution.yml up -d
#
# 2. Verificar se está rodando:
#    docker-compose -f docker-compose.evolution.yml ps
#
# 3. Ver logs:
#    docker-compose -f docker-compose.evolution.yml logs -f evolution-api
#
# 4. Parar:
#    docker-compose -f docker-compose.evolution.yml down
#
# 5. API estará disponível em:
#    http://localhost:8080
#
# 6. API Key configurada:
#    cybertv-suporte-evolution-key-2024
#
# 7. Documentação da Evolution API:
#    https://doc.evolution-api.com/
