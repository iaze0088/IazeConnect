import React, { useState, useEffect, useRef } from 'react';
import { Send, Loader2, X, Image as ImageIcon, Mic, Download, AlertCircle } from 'lucide-react';
import './VendasChatNew.css';

const BACKEND_URL = process.env.REACT_APP_BACKEND_URL || '';

function VendasChatNew() {
  const [sessionId, setSessionId] = useState(null);
  const [messages, setMessages] = useState([]);
  const [inputText, setInputText] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isSending, setIsSending] = useState(false);
  const [isProcessingMedia, setIsProcessingMedia] = useState(false);
  
  // Pop-ups
  const [showContactPopup, setShowContactPopup] = useState(false); // N√ÉO mostrar popup automaticamente (apenas se modo n√£o for "button")
  const [showCredentialsPopup, setShowCredentialsPopup] = useState(false);
  const [showExitConfirm, setShowExitConfirm] = useState(false);
  const [showAppInstallPopup, setShowAppInstallPopup] = useState(false); // üÜï NOVO: Popup de instala√ß√£o do app
  const [pendingTestData, setPendingTestData] = useState(null); // üÜï NOVO: Dados do teste pendente
  
  // Dados
  const [whatsapp, setWhatsapp] = useState('');
  const [pin, setPin] = useState('');
  const [clientName, setClientName] = useState(''); // NOVO: Nome do cliente
  const [credentials, setCredentials] = useState({ usuario: '', senha: '' });
  const [isGeneratingTest, setIsGeneratingTest] = useState(false);
  const [agentProfile, setAgentProfile] = useState({ 
    name: 'Assistente Virtual', 
    photo: '', 
    show_verified_badge: true 
  });
  
  // üÜï SISTEMA DE BOT√ïES
  const [buttonConfig, setButtonConfig] = useState({
    is_enabled: false,
    mode: 'ia',
    buttons: []
  });
  const [currentButtons, setCurrentButtons] = useState([]);
  
  const messagesEndRef = useRef(null);
  const inputRef = useRef(null);

  // Buscar perfil do agente da config
  useEffect(() => {
    const fetchAgentProfile = async () => {
      try {
        const response = await fetch(`${BACKEND_URL}/api/admin/vendas-bot/simple-config`);
        if (response.ok) {
          const config = await response.json();
          if (config.agent_profile) {
            setAgentProfile(config.agent_profile);
          }
        }
      } catch (error) {
        console.error('Error loading agent profile:', error);
      }
    };
    
    fetchAgentProfile();
  }, []);

  // Capturar evento de instala√ß√£o PWA
  useEffect(() => {
    const handleBeforeInstallPrompt = (e) => {
      // Prevenir que o mini-infobar apare√ßa em mobile
      e.preventDefault();
      // Guardar o evento para usar depois
      window.deferredPrompt = e;
      console.log('‚úÖ PWA pode ser instalado!');
    };

    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    };
  }, []);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  useEffect(() => {
    // Verificar se h√° WhatsApp e Nome salvos no localStorage
    const savedWhatsapp = localStorage.getItem('vendas_whatsapp');
    const savedName = localStorage.getItem('vendas_name');
    initSession(savedWhatsapp, savedName);
  }, []);

  const initSession = async (initialWhatsapp = null, initialName = null) => {
    try {
      setIsLoading(true);
      const response = await fetch(`${BACKEND_URL}/api/vendas/start`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          whatsapp: initialWhatsapp || undefined,
          name: initialName || undefined
        })
      });
      const data = await response.json();
      setSessionId(data.session_id);
      setMessages(data.messages || []);
      
      // üÜï CARREGAR CONFIGURA√á√ÉO DE BOT√ïES
      console.log('üì¶ Resposta /start completa:', data);
      if (data.button_config) {
        console.log('‚úÖ button_config encontrado:', data.button_config);
        setButtonConfig(data.button_config);
        if (data.button_config.buttons) {
          console.log('‚úÖ Bot√µes encontrados:', data.button_config.buttons.length);
          setCurrentButtons(data.button_config.buttons);
        } else {
          console.warn('‚ö†Ô∏è button_config.buttons est√° vazio ou undefined');
        }
        console.log('üîò Sistema de bot√µes configurado:', data.button_config.mode);
        
        // üÜï Mostrar popup apenas se modo N√ÉO for "button"
        if (data.button_config.mode !== 'button' && !initialWhatsapp) {
          setShowContactPopup(true);
        }
      } else {
        // Sem configura√ß√£o de bot√µes, mostrar popup tradicional
        if (!initialWhatsapp) {
          setShowContactPopup(true);
        }
      }
    } catch (error) {
      console.error('Erro:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const sendMessage = async (e) => {
    e?.preventDefault();
    if (!inputText.trim() || !sessionId || isSending) return;
    
    const messageText = inputText.trim();
    setInputText('');
    setIsSending(true);
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/vendas/message`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId, text: messageText })
      });
      const data = await response.json();
      await new Promise(resolve => setTimeout(resolve, 10000));
      setMessages(prev => [...prev, ...data.messages]);
      
      // üÜï Atualizar bot√µes se retornados
      if (data.buttons) {
        setCurrentButtons(data.buttons);
      }
      
      // Verificar se tem bot√£o de solicitar teste
      const lastMessage = data.messages[data.messages.length - 1];
      if (lastMessage?.button_action === 'REQUEST_TEST') {
        // Aguardar um pouco e mostrar o pop-up
        setTimeout(() => setShowContactPopup(true), 1000);
      }
    } catch (error) {
      console.error('Erro:', error);
      alert('Erro ao enviar mensagem.');
    } finally {
      setIsSending(false);
    }
  };

  // üÜï FUN√á√ÉO PARA PROCESSAR CLIQUE EM BOT√ÉO
  const handleButtonClick = async (buttonId, buttonLabel) => {
    if (!sessionId || isSending) return;
    
    setIsSending(true);
    
    try {
      // Adicionar mensagem do cliente (clique no bot√£o)
      const userMessage = {
        message_id: Date.now().toString(),
        from_type: 'client',
        text: buttonLabel,
        timestamp: new Date().toISOString(),
        has_button: false
      };
      setMessages(prev => [...prev, userMessage]);
      
      // Processar clique no backend
      const response = await fetch(`${BACKEND_URL}/api/vendas/button-click`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          session_id: sessionId, 
          button_id: buttonId 
        })
      });
      
      if (!response.ok) {
        throw new Error('Erro ao processar bot√£o');
      }
      
      const data = await response.json();
      
      // Adicionar mensagem de resposta do bot
      setMessages(prev => [...prev, data.message]);
      
      // Atualizar bot√µes
      if (data.has_sub_buttons && data.buttons && data.buttons.length > 0) {
        setCurrentButtons(data.buttons);
      } else {
        // Se n√£o tem sub-bot√µes, manter os bot√µes atuais ou limpar
        setCurrentButtons([]);
      }
      
      console.log('‚úÖ Bot√£o processado:', buttonLabel);
      
    } catch (error) {
      console.error('‚ùå Erro ao processar bot√£o:', error);
      alert('Erro ao processar sua escolha. Tente novamente.');
    } finally {
      setIsSending(false);
    }
  };

  // üÜï FUN√á√ÉO PARA RESETAR MENU DE BOT√ïES
  const handleResetButtons = async () => {
    if (!sessionId) return;
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/vendas/button-reset`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId })
      });
      
      if (response.ok) {
        const data = await response.json();
        setCurrentButtons(data.buttons || []);
        console.log('‚úÖ Menu de bot√µes resetado');
      }
    } catch (error) {
      console.error('‚ùå Erro ao resetar menu:', error);
    }
  };

  const handleMediaUpload = async (file, mediaType) => {
    if (!file || !sessionId) return;
    
    // Mostrar pop-up de processamento
    const mediaTypeText = mediaType === 'audio' ? '√°udio' : mediaType === 'video' ? 'v√≠deo' : 'foto';
    alert(`Por favor, aguarde na conversa enquanto processamos o ${mediaTypeText}... ‚è≥`);
    
    setIsProcessingMedia(true);
    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('session_id', sessionId);
      formData.append('media_type', mediaType);
      
      const response = await fetch(`${BACKEND_URL}/api/vendas/media`, {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) throw new Error('Erro ao processar');
      
      const data = await response.json();
      
      // Remover delay desnecess√°rio - processar imediatamente
      setMessages(prev => [...prev, ...data.messages]);
    } catch (error) {
      console.error('Erro:', error);
      alert('Erro ao processar arquivo. Tente novamente.');
    } finally {
      setIsProcessingMedia(false);
    }
  };

  const handleFileSelect = (e, mediaType) => {
    const file = e.target.files[0];
    if (!file) return;
    e.target.value = '';
    const maxSize = mediaType === 'video' ? 50 : mediaType === 'audio' ? 25 : 20;
    if (file.size > maxSize * 1024 * 1024) {
      alert(`Arquivo muito grande. M√°ximo: ${maxSize}MB`);
      return;
    }
    handleMediaUpload(file, mediaType);
  };

  const handleRequestTest = async () => {
    if (!clientName.trim() || !whatsapp || !pin || pin.length !== 2) {
      alert('Preencha Nome, WhatsApp e PIN de 2 d√≠gitos!');
      return;
    }
    
    // üÜï NOVO FLUXO: Primeiro perguntar sobre instala√ß√£o do app
    setPendingTestData({ clientName, whatsapp, pin });
    setShowContactPopup(false);
    setShowAppInstallPopup(true);
  };
  
  // üÜï NOVO: Gerar teste ap√≥s confirmar instala√ß√£o do app
  const handleGenerateTestAfterAppInstall = async () => {
    if (!pendingTestData) return;
    
    setIsGeneratingTest(true);
    
    try {
      const { clientName, whatsapp, pin } = pendingTestData;
      
      // Salvar nome e whatsapp no localStorage
      localStorage.setItem('vendas_name', clientName);
      localStorage.setItem('vendas_whatsapp', whatsapp);
      
      const response = await fetch(`${BACKEND_URL}/api/vendas/request-test`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_id: sessionId,
          whatsapp: whatsapp,
          pin: pin,
          name: clientName
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Salvar credenciais
        setCredentials({
          usuario: data.usuario,
          senha: data.senha
        });
        
        // Fechar pop-up de instala√ß√£o e abrir de credenciais
        setShowAppInstallPopup(false);
        setShowCredentialsPopup(true);
        
        // Adicionar mensagem no chat
        setMessages(prev => [...prev, {
          from_type: 'bot',
          text: data.message,
          timestamp: new Date().toISOString()
        }]);
      } else {
        alert(data.message || 'Erro ao gerar teste');
        setShowAppInstallPopup(false);
      }
    } catch (error) {
      console.error('Erro:', error);
      alert('Erro ao solicitar teste');
      setShowAppInstallPopup(false);
    } finally {
      setIsGeneratingTest(false);
      setPendingTestData(null);
    }
  };
  
  // üÜï NOVO: Cliente recusou instalar app
  const handleDeclineAppInstall = () => {
    setShowAppInstallPopup(false);
    
    // Enviar mensagem de erro
    setMessages(prev => [...prev, {
      from_type: 'bot',
      text: '‚ùå N√£o foi poss√≠vel gerar o teste gr√°tis.\n\nPara receber suas credenciais, voc√™ precisa instalar o aplicativo suporte.help.\n\nDeseja instalar o aplicativo agora?',
      timestamp: new Date().toISOString()
    }]);
    
    // Reabrir popup ap√≥s 1 segundo
    setTimeout(() => {
      setShowAppInstallPopup(true);
    }, 1500);
  };

  const handleDownloadApp = async () => {
    setShowCredentialsPopup(false);
    
    // Salvar dados no localStorage ANTES de instalar
    localStorage.setItem('iaze_whatsapp', whatsapp);
    localStorage.setItem('iaze_pin', pin);
    localStorage.setItem('iaze_iptv_user', credentials.usuario);
    localStorage.setItem('iaze_iptv_pass', credentials.senha);
    localStorage.setItem('iaze_from_vendas', 'true');
    localStorage.setItem('iaze_vendas_session', sessionId);
    
    console.log('üíæ Dados salvos no localStorage:');
    console.log('  - iaze_whatsapp:', localStorage.getItem('iaze_whatsapp'));
    console.log('  - iaze_pin:', localStorage.getItem('iaze_pin'));
    console.log('  - iaze_from_vendas:', localStorage.getItem('iaze_from_vendas'));
    
    // Migrar sess√£o para o chat principal
    try {
      await fetch(`${BACKEND_URL}/api/vendas/migrate-session`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          vendas_session_id: sessionId,
          whatsapp: whatsapp,
          pin: pin,
          credentials: credentials
        })
      });
      console.log('‚úÖ Sess√£o migrada com sucesso');
    } catch (error) {
      console.error('Erro ao migrar sess√£o:', error);
    }
    
    // Verificar se PWA est√° dispon√≠vel para instala√ß√£o
    if (window.deferredPrompt) {
      // Mostrar prompt de instala√ß√£o
      window.deferredPrompt.prompt();
      
      // Aguardar resposta do usu√°rio
      const { outcome } = await window.deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        console.log('‚úÖ PWA instalado com sucesso!');
        
        // Limpar o prompt
        window.deferredPrompt = null;
        
        // Mostrar pop-up de confirma√ß√£o
        alert('‚úÖ Nosso aplicativo de SUPORTE j√° est√° instalado em seu celular!');
        
        // Determinar URL de redirecionamento (usa hostname atual se n√£o for localhost)
        const currentHost = window.location.hostname;
        const redirectUrl = (currentHost !== 'localhost' && currentHost !== '127.0.0.1')
          ? window.location.origin 
          : '/';
        
        console.log('üîÑ Redirecionando para:', redirectUrl);
        
        // Redirecionar ap√≥s confirma√ß√£o
        window.location.href = redirectUrl;
      } else {
        console.log('‚ùå Usu√°rio recusou instala√ß√£o');
        alert('Por favor, instale o aplicativo para continuar com melhor experi√™ncia!');
      }
    } else {
      // PWA j√° instalado OU n√£o dispon√≠vel - apenas redirecionar
      console.log('‚ÑπÔ∏è PWA n√£o dispon√≠vel ou j√° instalado');
      alert('‚úÖ Aplicativo pronto! Redirecionando para o suporte...');
      
      // Determinar URL de redirecionamento (usa hostname atual se n√£o for localhost)
      const currentHost = window.location.hostname;
      const redirectUrl = (currentHost !== 'localhost' && currentHost !== '127.0.0.1')
        ? window.location.origin 
        : '/';
      
      console.log('üîÑ Redirecionando para:', redirectUrl);
      
      // Redirecionar ap√≥s 1 segundo
      setTimeout(() => {
        window.location.href = redirectUrl;
      }, 1000);
    }
  };

  const handleInstallApp = async () => {
    // Validar dados antes de prosseguir
    if (!whatsapp || !pin || pin.length !== 2) {
      alert('Por favor, preencha WhatsApp e PIN corretamente!');
      return;
    }
    
    try {
      // 1. Salvar tudo no localStorage ANTES de redirecionar
      localStorage.setItem('iaze_whatsapp', whatsapp);
      localStorage.setItem('iaze_pin', pin);
      localStorage.setItem('iaze_iptv_user', credentials.usuario);
      localStorage.setItem('iaze_iptv_pass', credentials.senha);
      localStorage.setItem('iaze_from_vendas', 'true');
      localStorage.setItem('iaze_vendas_session', sessionId);
      
      // 2. Migrar sess√£o do /vendas para o chat principal
      await fetch(`${BACKEND_URL}/api/vendas/migrate-session`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          vendas_session_id: sessionId,
          whatsapp: whatsapp,
          pin: pin,
          credentials: credentials
        })
      });
      
      // 3. Fechar pop-up
      setShowAppDownloadPopup(false);
      
      // 4. Mensagem de sucesso
      setMessages(prev => [...prev, {
        from_type: 'bot',
        text: 'Agora que recebeu o usu√°rio e senha, "POR FAVOR" instala nosso aplicativo de Suporte Humanizado pra realizar a contrata√ß√£o ap√≥s o teste! üì±\n\nVoc√™ ser√° redirecionado em 3 segundos...',
        timestamp: new Date().toISOString()
      }]);
      
      // 5. Redirecionar para o dom√≠nio atual (dados j√° salvos)
      setTimeout(() => {
        window.location.href = window.location.origin;
      }, 3000);
      
    } catch (error) {
      console.error('Erro ao processar instala√ß√£o:', error);
      alert('Erro ao processar. Tente novamente.');
    }
  };

  const handleCloseChat = () => {
    setShowExitConfirm(true);
  };

  const confirmExit = (shouldExit) => {
    if (shouldExit) {
      // Mostrar mensagem de despedida
      setMessages(prev => [...prev, {
        from_type: 'bot',
        text: 'Caso voc√™ mude de ideia me chama nesse link de suporte!\n\nAt√© mais! üëã',
        timestamp: new Date().toISOString()
      }]);
      
      // Aguardar um pouco e redirecionar
      setTimeout(() => {
        window.location.href = '/';
      }, 2000);
    }
    setShowExitConfirm(false);
  };

  // Fun√ß√£o para formatar mensagem com links e destaques
  const formatMessageText = (text) => {
    if (!text) return text;
    
    // Regex para detectar URLs
    const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+)/gi;
    
    // Regex para detectar padr√µes importantes (usu√°rio: xxx, senha: xxx, c√≥digo: xxx)
    const highlightRegex = /(usuario|usu√°rio|senha|codigo|c√≥digo|login|email|telefone|cpf|chave):\s*([^\s,;.\n]+)/gi;
    
    let parts = [];
    let lastIndex = 0;
    
    // Processar texto caractere por caractere
    text.replace(urlRegex, (match, offset) => {
      // Adicionar texto antes do link
      if (offset > lastIndex) {
        const beforeText = text.substring(lastIndex, offset);
        parts.push({ type: 'text', content: beforeText });
      }
      
      // Adicionar link
      const url = match.startsWith('www.') ? `https://${match}` : match;
      parts.push({ type: 'link', content: match, url: url });
      
      lastIndex = offset + match.length;
    });
    
    // Adicionar texto restante
    if (lastIndex < text.length) {
      parts.push({ type: 'text', content: text.substring(lastIndex) });
    }
    
    // Se n√£o encontrou links, processar texto normal
    if (parts.length === 0) {
      parts.push({ type: 'text', content: text });
    }
    
    // Processar destaques em cada parte de texto
    const finalParts = [];
    parts.forEach(part => {
      if (part.type === 'text') {
        const textParts = [];
        let textLastIndex = 0;
        
        part.content.replace(highlightRegex, (match, label, value, offset) => {
          // Texto antes do destaque
          if (offset > textLastIndex) {
            textParts.push({ type: 'text', content: part.content.substring(textLastIndex, offset) });
          }
          
          // Destaque
          textParts.push({ 
            type: 'highlight', 
            label: label, 
            value: value 
          });
          
          textLastIndex = offset + match.length;
        });
        
        // Texto restante
        if (textLastIndex < part.content.length) {
          textParts.push({ type: 'text', content: part.content.substring(textLastIndex) });
        }
        
        if (textParts.length > 0) {
          finalParts.push(...textParts);
        } else {
          finalParts.push(part);
        }
      } else {
        finalParts.push(part);
      }
    });
    
    return finalParts;
  };

  const renderMessage = (msg, index) => {
    const senderClass = msg.from_type === 'client' ? 'user' : 'bot';
    const formattedParts = formatMessageText(msg.text);
    
    return (
      <div key={index} className={`vendas-message ${senderClass}`}>
        <div className="vendas-message-bubble">
          <div className="vendas-message-text">
            {Array.isArray(formattedParts) ? (
              formattedParts.map((part, i) => {
                if (part.type === 'link') {
                  return (
                    <a 
                      key={i} 
                      href={part.url} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      style={{ 
                        color: '#3b82f6', 
                        textDecoration: 'underline',
                        wordBreak: 'break-all'
                      }}
                    >
                      {part.content}
                    </a>
                  );
                } else if (part.type === 'highlight') {
                  return (
                    <span key={i}>
                      <span style={{ fontWeight: 'normal' }}>{part.label}: </span>
                      <strong 
                        style={{ 
                          backgroundColor: '#fef3c7', 
                          padding: '2px 6px', 
                          borderRadius: '4px',
                          fontWeight: 'bold',
                          color: '#92400e'
                        }}
                      >
                        {part.value}
                      </strong>
                    </span>
                  );
                } else {
                  return <span key={i}>{part.content}</span>;
                }
              })
            ) : (
              <span>{msg.text}</span>
            )}
          </div>
          
          {msg.button_action === 'REQUEST_TEST' && (
            <button 
              className="vendas-action-button"
              onClick={() => setShowContactPopup(true)}
            >
              üöÄ CONECTAR AGORA
            </button>
          )}
          
          <span className="vendas-message-time">
            {new Date(msg.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
          </span>
        </div>
      </div>
    );
  };

  if (isLoading) {
    return (
      <div className="vendas-chat-container">
        <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'100%',color:'white'}}>
          <Loader2 size={48} style={{animation:'spin 1s linear infinite',marginBottom:'16px'}} />
          <p>Iniciando conversa...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="vendas-chat-container">
      {/* Header */}
      <div className="vendas-chat-header">
        <div className="vendas-chat-header-info">
          <div className="vendas-chat-avatar">
            {agentProfile.photo ? (
              <img 
                src={agentProfile.photo} 
                alt="Agente" 
                style={{ 
                  width: '40px', 
                  height: '40px', 
                  borderRadius: '50%', 
                  objectFit: 'cover' 
                }}
                onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'block'; }}
              />
            ) : null}
            <span style={{ display: agentProfile.photo ? 'none' : 'block', fontSize: '24px' }}>ü§ñ</span>
          </div>
          <div className="vendas-chat-title">
            <p className="vendas-chat-name" style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
              {agentProfile.name || 'Assistente Virtual'}
              {agentProfile.show_verified_badge && (
                <span 
                  style={{ 
                    display: 'inline-flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    width: '16px',
                    height: '16px',
                    backgroundColor: '#1d9bf0',
                    borderRadius: '50%',
                    color: 'white',
                    fontSize: '10px',
                    fontWeight: 'bold',
                    marginLeft: '2px'
                  }}
                  title="Verificado"
                >
                  ‚úì
                </span>
              )}
            </p>
            <p className="vendas-chat-status">{isProcessingMedia ? 'Processando m√≠dia...' : 'Online'}</p>
          </div>
        </div>
        <button className="vendas-chat-close-btn" onClick={handleCloseChat}>
          <X size={20} />
        </button>
      </div>

      {/* Mensagens */}
      <div className="vendas-chat-messages-area">
        {messages.map((msg, i) => renderMessage(msg, i))}
        
        {isSending && (
          <div className="vendas-message bot">
            <div className="vendas-typing-indicator">
              <div className="vendas-typing-dot"></div>
              <div className="vendas-typing-dot"></div>
              <div className="vendas-typing-dot"></div>
            </div>
          </div>
        )}
        
        {isProcessingMedia && (
          <div className="vendas-message bot">
            <div className="vendas-message-bubble">
              <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                <Loader2 size={16} style={{animation:'spin 1s linear infinite'}} />
                <span>Processando arquivo...</span>
              </div>
            </div>
          </div>
        )}
        
        <div ref={messagesEndRef} />
      </div>

      {/* üÜï BOT√ïES INTERATIVOS */}
      {buttonConfig.is_enabled && currentButtons.length > 0 && (
        <div className="vendas-buttons-container" style={{
          padding: '16px',
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
          backgroundColor: '#f5f5f5',
          borderTop: '1px solid #e0e0e0'
        }}>
          {currentButtons.map((button) => (
            <button
              key={button.id}
              onClick={() => handleButtonClick(button.id, button.label)}
              disabled={isSending}
              style={{
                padding: '12px 16px',
                backgroundColor: '#25D366',
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                fontSize: '15px',
                fontWeight: '500',
                cursor: isSending ? 'not-allowed' : 'pointer',
                opacity: isSending ? 0.6 : 1,
                transition: 'all 0.2s',
                textAlign: 'left',
                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
              }}
              onMouseEnter={(e) => {
                if (!isSending) {
                  e.target.style.backgroundColor = '#1fb855';
                  e.target.style.transform = 'translateY(-2px)';
                  e.target.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                }
              }}
              onMouseLeave={(e) => {
                if (!isSending) {
                  e.target.style.backgroundColor = '#25D366';
                  e.target.style.transform = 'translateY(0)';
                  e.target.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                }
              }}
            >
              {button.label}
            </button>
          ))}
        </div>
      )}

      {/* Input - Ocultar se modo = "button" */}
      <div className="vendas-chat-input-area" style={{
        display: (buttonConfig.is_enabled && buttonConfig.mode === 'button') ? 'none' : 'flex'
      }}>
        <div className="vendas-media-buttons">
          <button className="vendas-media-btn" title="Enviar foto ou v√≠deo" disabled={isProcessingMedia}>
            <ImageIcon size={26} />
            <input type="file" accept="image/*,video/*" onChange={(e) => handleFileSelect(e, e.target.files[0]?.type.startsWith('video') ? 'video' : 'image')} disabled={isProcessingMedia} />
          </button>
          <button className="vendas-media-btn" title="Enviar √°udio" disabled={isProcessingMedia}>
            <Mic size={26} />
            <input type="file" accept="audio/*" onChange={(e) => handleFileSelect(e, 'audio')} disabled={isProcessingMedia} />
          </button>
        </div>
        <div className="vendas-input-wrapper">
          <textarea ref={inputRef} className="vendas-chat-input" placeholder="Digite uma mensagem..." value={inputText} onChange={(e) => setInputText(e.target.value)} onKeyPress={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }} rows={1} disabled={isSending || isProcessingMedia} />
        </div>
        <button className="vendas-send-btn" onClick={sendMessage} disabled={!inputText.trim() || isSending || isProcessingMedia}>
          <Send size={20} />
        </button>
      </div>

      {/* Pop-up 1: Solicitar WhatsApp + PIN + Nome */}
      {showContactPopup && (
        <div className="vendas-popup-overlay">
          <div className="vendas-popup">
            <h3>üì± Digite seus dados</h3>
            <p>Para gerar o teste, precisamos do seu nome, WhatsApp e uma senha de 2 d√≠gitos</p>
            
            <input
              type="text"
              placeholder="Nome (ex: Jo√£o)"
              value={clientName}
              onChange={(e) => setClientName(e.target.value)}
              className="vendas-popup-input"
            />
            
            <input
              type="tel"
              placeholder="WhatsApp (ex: 11999999999)"
              value={whatsapp}
              onChange={(e) => setWhatsapp(e.target.value.replace(/\D/g, ''))}
              maxLength="11"
              className="vendas-popup-input"
            />
            
            <input
              type="text"
              placeholder="Senha de 2 d√≠gitos (ex: 42)"
              value={pin}
              onChange={(e) => setPin(e.target.value.replace(/\D/g, ''))}
              maxLength="2"
              className="vendas-popup-input"
            />
            
            <button 
              className="vendas-popup-btn"
              onClick={handleRequestTest}
              disabled={isGeneratingTest || !clientName.trim() || !whatsapp || pin.length !== 2}
            >
              {isGeneratingTest ? (
                <>
                  <Loader2 size={16} style={{animation:'spin 1s linear infinite'}} />
                  Gerando...
                </>
              ) : (
                'üéâ GERAR TESTE'
              )}
            </button>
            
            <button className="vendas-popup-btn-cancel" onClick={() => {
              // Salvar WhatsApp e Nome mesmo se cancelar
              if (whatsapp) {
                localStorage.setItem('vendas_whatsapp', whatsapp);
              }
              if (clientName) {
                localStorage.setItem('vendas_name', clientName);
              }
              initSession(whatsapp, clientName);
              setShowContactPopup(false);
            }}>
              Continuar sem gerar teste
            </button>
          </div>
        </div>
      )}

      {/* üÜï NOVO Pop-up: Confirmar Instala√ß√£o do App */}
      {showAppInstallPopup && (
        <div className="vendas-popup-overlay">
          <div className="vendas-popup">
            <h3>üì± Instalar Aplicativo</h3>
            <p style={{marginBottom: '20px'}}>
              Antes de gerar o teste gr√°tis, voc√™ precisa instalar nosso aplicativo <strong>suporte.help</strong>
            </p>
            
            <div style={{background: '#f3f4f6', padding: '16px', borderRadius: '8px', marginBottom: '20px'}}>
              <p style={{margin: '0', fontSize: '14px', color: '#666'}}>
                ‚ÑπÔ∏è O aplicativo √© necess√°rio para voc√™ utilizar suas credenciais de teste
              </p>
            </div>
            
            <p style={{fontSize: '16px', fontWeight: 'bold', marginBottom: '16px'}}>
              Voc√™ j√° instalou o aplicativo?
            </p>
            
            <div style={{display: 'flex', gap: '12px'}}>
              <button 
                className="vendas-popup-btn"
                onClick={handleGenerateTestAfterAppInstall}
                disabled={isGeneratingTest}
                style={{flex: 1}}
              >
                {isGeneratingTest ? (
                  <>
                    <Loader2 size={16} style={{animation:'spin 1s linear infinite'}} />
                    Gerando...
                  </>
                ) : (
                  '‚úÖ SIM, INSTALAR'
                )}
              </button>
              
              <button 
                className="vendas-popup-btn-cancel"
                onClick={handleDeclineAppInstall}
                disabled={isGeneratingTest}
                style={{flex: 1}}
              >
                ‚ùå N√ÉO INSTALEI
              </button>
            </div>
            
            <p style={{fontSize: '12px', color: '#888', marginTop: '16px', textAlign: 'center'}}>
              Clique em "SIM, INSTALAR" quando tiver instalado o app
            </p>
          </div>
        </div>
      )}

      {/* Pop-up 2: Credenciais Geradas */}
      {showCredentialsPopup && (
        <div className="vendas-popup-overlay">
          <div className="vendas-popup">
            <h3>üéâ Teste Criado!</h3>
            <p>Suas credenciais foram geradas com sucesso:</p>
            
            <div className="vendas-credentials">
              <div className="vendas-credential-item">
                <strong>üë§ Usu√°rio:</strong>
                <span>{credentials.usuario}</span>
              </div>
              <div className="vendas-credential-item">
                <strong>üîê Senha:</strong>
                <span>{credentials.senha}</span>
              </div>
            </div>
            
            <button className="vendas-popup-btn" onClick={handleDownloadApp}>
              <Download size={16} />
              BAIXAR APLICATIVO
            </button>
          </div>
        </div>
      )}

      {/* Pop-up 4: Confirma√ß√£o de Sa√≠da */}
      {showExitConfirm && (
        <div className="vendas-popup-overlay">
          <div className="vendas-popup">
            <AlertCircle size={48} style={{color:'#f59e0b',margin:'0 auto 16px'}} />
            <h3>Voc√™ deseja continuar na p√°gina?</h3>
            
            <div style={{display:'flex',gap:'12px',marginTop:'24px'}}>
              <button className="vendas-popup-btn" onClick={() => confirmExit(false)}>
                ‚úÖ SIM
              </button>
              <button className="vendas-popup-btn-cancel" onClick={() => confirmExit(true)}>
                ‚ùå N√ÉO
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export default VendasChatNew;
