<!DOCTYPE html>
<html>
<head>
    <title>Test Agent Token</title>
</head>
<body>
    <h1>Test Agent Dashboard Token</h1>
    <button onclick="testLogin()">1. Login como fabioteste</button>
    <button onclick="testGetTickets()">2. Get Tickets com token</button>
    <button onclick="checkLocalStorage()">3. Ver localStorage</button>
    <button onclick="clearStorage()">4. Limpar localStorage</button>
    <pre id="output"></pre>

    <script>
        const BACKEND_URL = 'https://wppconnect-fix.preview.emergentagent.com/api';
        const output = document.getElementById('output');

        function log(msg) {
            output.textContent += msg + '\n';
        }

        async function testLogin() {
            output.textContent = '';
            log('üîê Fazendo login como fabioteste...');
            
            try {
                const response = await fetch(`${BACKEND_URL}/auth/agent/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ login: 'fabioteste', password: '123' })
                });
                
                const data = await response.json();
                log('‚úÖ Login bem-sucedido!');
                log('Token: ' + data.token.substring(0, 50) + '...');
                log('Reseller ID: ' + data.reseller_id);
                log('User Type: ' + data.user_type);
                
                // Salvar no localStorage
                localStorage.setItem('token', data.token);
                localStorage.setItem('user_type', data.user_type);
                localStorage.setItem('user_data', JSON.stringify(data.user_data));
                
                log('\n‚úÖ Token salvo no localStorage');
            } catch (error) {
                log('‚ùå Erro: ' + error.message);
            }
        }

        async function testGetTickets() {
            output.textContent = '';
            const token = localStorage.getItem('token');
            
            if (!token) {
                log('‚ùå Nenhum token encontrado! Fa√ßa login primeiro.');
                return;
            }
            
            log('üé´ Buscando tickets com token...');
            log('Token: ' + token.substring(0, 50) + '...');
            
            try {
                const response = await fetch(`${BACKEND_URL}/tickets`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const tickets = await response.json();
                log(`\n‚úÖ Resposta recebida: ${tickets.length} tickets`);
                log('\nTickets:');
                log(JSON.stringify(tickets, null, 2));
                
                if (tickets.length === 0) {
                    log('\n‚úÖ CORRETO! Agent fabioteste v√™ 0 tickets (isolamento OK)');
                } else {
                    log(`\n‚ùå PROBLEMA! Agent deveria ver 0 tickets, mas v√™ ${tickets.length}`);
                }
            } catch (error) {
                log('‚ùå Erro: ' + error.message);
            }
        }

        function checkLocalStorage() {
            output.textContent = '';
            log('üì¶ Conte√∫do do localStorage:\n');
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                log(`${key}: ${value.substring(0, 100)}...`);
            }
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            output.textContent = '‚úÖ localStorage e sessionStorage limpos!';
        }
    </script>
</body>
</html>
